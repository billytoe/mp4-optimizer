## 1. 项目概述

**项目名称：** MP4 快速启动检测与优化工具 (FastStart Inspector & Optimizer) **目标：** 开发一个轻量化的跨平台桌面应用，用于检测并优化 MP4 文件的 `moov` 原子（Atom）位置。通过视觉化反馈（绿点/红点）识别视频状态，并提供一键式安全优化功能，使视频支持网络秒开。

## 2. 目标平台

- **Windows:** x64/ARM64 架构（**执行时隐藏黑色控制台窗口，严禁闪烁**）。
- **macOS:** Universal Binary (Intel/Apple Silicon 兼容)。
- **Ubuntu:** 适配主流 Linux 发行版。

## 3. 技术路线

- **后端：** Golang 1.26+。
- **前端/UI：** Wails 框架 (Next.js 15 + Tailwind CSS + shadcn/ui)。
- **构建参数：** Windows 编译使用 `-ldflags="-H windowsgui"` 消除控制台。
- **核心库：** 采用原生 Go 实现的 `faststart` 逻辑，避免调用外部命令行工具产生的闪烁。

## 4. 功能需求

### 4.1 文件输入

- **打开按钮：** 触发原生文件选择器，支持多选 MP4，可以多次选择不同文件。
- **添加文件夹（新增）：** 触发原生文件夹选择器，**递归扫描**选中目录及其子目录下的所有 MP4 文件并添加到列表中。
- **拖拽支持：** 
  - 支持将一个或多个 MP4 文件直接拖入应用窗口。
  - **支持文件夹拖拽**：自动递归扫描拖入文件夹内的所有 MP4 文件。
  - 自动去重并显示绝对路径，确保不同目录下的同名文件能被正确处理。

### 4.2 识别引擎

- **状态判定：**
  - **绿色圆点：** `moov` 在头部（已优化）。
  - **红色圆点：** `moov` 在尾部（待优化）。
- **元数据提取（新增）：** 
  - 提取并显示分辨率（如 1920x1080）、编码格式（如 avc1）、时长、文件大小及修改时间。
- **并发处理：** 针对 **Mac 系统** 及高性能多核环境，支持并行分析多个文件。

### 4.3 一键优化功能 (核心新增)

针对列表中的“红色圆点”（未优化）文件，提供“一键优化”按钮。

- **执行约束：** 仅处理未优化的文件，已优化的文件保持不动。
- **安全转换逻辑（逐个文件执行）：**
  1. **备份：** 将原始文件重命名为 `{原文件名}.bak`。
  2. **生成：** 读取 `.bak` 文件，在相同目录下创建原文件名的文件，并将 `moov` 原子移至文件头部写入。
  3. **校验：** 检查新生成文件的完整性（对比字节流或基础原子结构）。
  4. **自动清理：** 校验通过后，**自动删除** `.bak` 备份文件，节省磁盘空间。
  5. **状态更新：** UI 上的圆点由红变绿。

### 4.4 UI 交互设计

- **完全中文化：** 界面所有文本（标题、按钮、状态）已本地化为中文。
- **列表视图：** 
  - 显示序号、文件名、详细路径、元数据（分辨率、编码、时长）。
  - 支持 **垂直滚动条**，适应大量文件列表。
  - 顶部显示 **文件总数**。
- **视频预览（新增）：**
  - 点击列表中的文件支持在应用内弹窗播放。
  - 支持播放本地视频，兼容带特殊字符（如 #, 中文）的文件名。
  - 显示视频详细技术参数。
- **操作栏：** 包含“添加文件”、“添加文件夹”、“全部优化”、“清空”按钮。
- **进度反馈：** 优化过程中显示转圈动画，防止界面假死。

## 5. 项目目录结构

Plaintext

```
mp4-optimizer/
├── build/                 # 编译产物
├── frontend/              # UI 实现 (Next.js + shadcn/ui)
├── docs/              # 项目文档
│   └── PRD.md             # 当前文档
├── internal/
│   ├── analyzer/          # 识别 moov 位置的逻辑
│   ├── optimizer/         # 处理 .bak 转换及原子重排的核心逻辑
│   └── bridge/            # 前后端通信接口
├── pkg/
│   └── atomic/            # 封装 MP4 原子读写工具
├── AGENTS.md              # AI 指令约束
└── main.go                # 入口文件
```

## 6. 优先级排序

1. **P0:** 实现 Windows 无窗口启动及基本 UI 框架。
2. **P0:** 实现 MP4 `moov` 位置的高速检测逻辑。
3. **P1:** 实现基于 `.bak` 机制的安全优化转换算法。
4. **P1:** 实现文件拖拽及状态实时更新。

------

## 技术实现细节建议

1. **文件安全：** 在执行 `os.Rename` 生成 `.bak` 之前，程序会先检查磁盘空间，确保有足够的空间生成新文件。
2. **原子重排：** 为了在 **Mac 系统** 上达到极致速度，优化过程将采用内存映射（Mmap）或大缓冲区读写，通过计算偏移量直接重组原子顺序，而非重新编码视频。
3. **校验机制：** 在删除 `.bak` 前，至少对比新旧文件的总媒体数据（`mdat`）长度，确保视频数据未损坏。